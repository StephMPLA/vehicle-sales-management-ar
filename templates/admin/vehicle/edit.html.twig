{% extends 'base.html.twig' %}

{% block title %}Edit Vehicle{% endblock %}

{% block javascripts %}
    <script src="{{ asset('js/admin/vehicles/vehicle-image-delete.js') }}"></script>
    <script src="{{ asset('js/admin/vehicles/vehicle-image-upload.js') }}"></script>
{#    <script src="{{ asset('js/admin/vehicles/vehicle-model3d-upload.js') }}"></script>#}
    <script src="{{ asset('js/admin/vehicles/vehicle-model3d-delete.js') }}"></script>

{% endblock %}

{% block body %}

    <div class="min-h-screen bg-gray-100 py-10">
        <div class="max-w-5xl mx-auto px-6">

            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Edit Vehicle</h1>
                    <p class="text-gray-500 text-sm">Update vehicle data, images and 3D model</p>
                </div>

                <a href="{{ path('app_admin_dashboard') }}"
                   class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">← Back</a>
            </div>

            {# ================= VEHICLE FORM (fields + glb) ================= #}
            <div class="bg-white shadow-xl rounded-xl p-8">
                {{ form_start(form, {
                    attr: {
                        enctype: "multipart/form-data",
                        class: "space-y-10",
                        'data-turbo': 'false'
                    }
                }) }}

                {{ form_errors(form) }}

                <div>
                    <h2 class="text-xl font-semibold border-b pb-2 mb-6">Vehicle information</h2>

                    <div class="grid md:grid-cols-2 gap-6">
                        {{ form_row(form.name) }}
                        {{ form_row(form.year) }}
                        {{ form_row(form.horsePower) }}
                        {{ form_row(form.weight) }}
                        {{ form_row(form.price) }}
                        {{ form_row(form.mileage) }}
                        {{ form_row(form.isNew) }}
                        {{ form_row(form.brand) }}
                        {{ form_row(form.category) }}
                        {{ form_row(form.fuel) }}
                        {{ form_row(form.transmission) }}
                        {{ form_row(form.status) }}
                    </div>

                    <div class="mt-6">
                        {{ form_row(form.description) }}
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-semibold border-b pb-2 mb-4">3D Model (.glb)</h2>
                    <div class="bg-gray-50 border rounded-lg p-6">
                        {{ form_row(form.model3dFile) }}
                    </div>
                    {% if vehicle.model3dPath %}
                        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded">
                            <p class="text-sm text-green-700 font-medium">
                                ✅ Current 3D model uploaded
                            </p>
                            <button
                                type="button"
                                id="deleteModelBtn"
                                class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm"
                                data-delete-url="{{ path('admin_vehicle_model_delete', { id: vehicle.id }) }}"
                                data-csrf="{{ csrf_token('delete_vehicle_model_' ~ vehicle.id) }}">
                                Delete 3D model
                            </button>
                        </div>
                        <div class="bg-gray-500 rounded-lg p-4">
                            <model-viewer
                                src="{{ vehicle.model3dPath }}"
                                camera-controls
                                auto-rotate
                                shadow-intensity="1"
                                style="width:100%; height:400px;">
                            </model-viewer>
                        </div>
                    {% endif %}
                </div>

                {# ✅ SAVE véhicule (champs + glb) #}
                <div class="flex justify-end pt-6 border-t">
                    <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold">
                        Save vehicle changes
                    </button>
                </div>

                {{ form_end(form) }}
            </div>


            {# ================= AJAX IMAGE UPLOAD ================= #}
            <div class="bg-white shadow-xl rounded-xl p-8 mt-8">
                <h2 class="text-xl font-semibold border-b pb-2 mb-6">Add a new image (instant)</h2>

                <div id="uploadError" class="hidden mb-4 text-red-700 bg-red-50 border border-red-200 rounded p-3 text-sm"></div>

                <div class="border rounded-lg p-5 bg-gray-50">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Image file</label>
                            <input id="imgFile"
                                   type="file"
                                   accept="image/png,image/jpeg,image/webp"
                                   class="block w-full border rounded p-2 bg-white">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Type</label>
                            <select id="imgType" class="block w-full border rounded p-2 bg-white">
                                <option value="Front view">Front view</option>
                                <option value="Rear view">Rear view</option>
                                <option value="Interior">Interior</option>
                                <option value="Engine">Engine</option>
                                <option value="Trunk">Trunk</option>
                                <option value="Detail">Detail</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-4 flex items-center gap-3">

                        <button
                            id="uploadBtn"
                            type="button"
                            class="bg-gray-900 hover:bg-gray-800 text-white px-4 py-2 rounded-lg text-sm disabled:opacity-50"
                            disabled>
                            Upload image
                        </button>

                        <div
                            id="imageUploadConfig"
                            data-upload-url="{{ path(
                                'app_admin_vehicle_image_upload',
                                { id: vehicle.id }
                            ) }}"
                            data-upload-csrf="{{ csrf_token('vehicle_image_upload') }}">
                        </div>

                        <span id="uploadStatus"
                              class="text-sm text-gray-600"></span>
                    </div>
                </div>
            </div>


            {# ================= CURRENT IMAGES ================= #}
            <div class="bg-white shadow-xl rounded-xl p-8 mt-8">
                <h2 class="text-xl font-semibold border-b pb-2 mb-6">Current images</h2>

                <div id="currentImagesGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% set existingImages = vehicle.images|filter(i => i.path) %}
                    {% for img in existingImages %}
                        {% include 'admin/vehicle/components/_vehicle_image_card.html.twig'
                            with { image: img } %}
                    {% else %}
                        <p id="noImagesText"
                           class="text-gray-500 col-span-full">
                            No images uploaded.
                        </p>
                    {% endfor %}
                </div>

            </div>

        </div>
    </div>
{% endblock %}
